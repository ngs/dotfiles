#!/bin/sh
#
# Use: Put something this in your .tmux.conf file
# set -g status-right: '#(wifi-signal-strength)'
#

# Check if Wi-Fi is powered on
wifi_power=$(networksetup -getairportpower en0 2>/dev/null | awk '{print $NF}')
if [ "$wifi_power" != "On" ]; then
  echo "(WiFi off)"
  exit 0
fi

# Get RSSI and Tx rate via CoreWLAN (macOS only)
wifi_info=$(swift -e '
import CoreWLAN
if let iface = CWWiFiClient.shared().interface() {
    if iface.powerOn() {
        print("\(iface.rssiValue())|\(Int(iface.transmitRate()))")
    } else {
        print("off")
    }
}
' 2>/dev/null)

if [ -z "$wifi_info" ] || [ "$wifi_info" = "off" ]; then
  echo "(WiFi off)"
  exit 0
fi

rssi=$(echo "$wifi_info" | cut -d'|' -f1)
bandwidth=$(echo "$wifi_info" | cut -d'|' -f2)

# Check if we actually have a connection (RSSI 0 means not connected)
if [ "$rssi" -eq 0 ] 2>/dev/null; then
  echo "(no connection)"
  exit 0
fi

# Build signal bar based on RSSI
# Typical ranges: -30 excellent, -50 good, -70 fair, -90 weak
signal="( "
if [ "$rssi" -gt -94 ]; then signal="${signal}▁ "; else signal="${signal}  "; fi
if [ "$rssi" -gt -86 ]; then signal="${signal}▃ "; else signal="${signal}  "; fi
if [ "$rssi" -gt -70 ]; then signal="${signal}▅ "; else signal="${signal}  "; fi
if [ "$rssi" -gt -50 ]; then signal="${signal}▇ "; else signal="${signal}  "; fi
signal="${signal})"

echo "${bandwidth}Mbps ${signal}"
